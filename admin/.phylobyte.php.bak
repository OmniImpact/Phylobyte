<?php

class phylobyte{

	public $messageStampBase;
	public $messageStampItr = 0;
	public $messageArea;
	public $navigationArea;
	public $breadcrumbs;
	public $pageArea;
	public $docArea;
	public $headArea;
	public $pageTitle = 'Phylobyte CMS';
	
	static $sessionUserInfo;
	
	static $phylobyteDB;

	function __construct(){
		$this->messageStampBase = time();
		try{
			include('../data/database.vars.php');
			$this->phylobyteDB = new PDO('mysql:host=localhost;dbname='.$DBMASTERDB, $DBUSER, $DBPASSWORD);
		}catch(PDOException $e){
			$this->messageAddDebug('Failed to open database: '.$e);
		}
		try{
			$this->phylobyteDB->exec("
				CREATE TABLE IF NOT EXISTS p_groups(
					id INTEGER PRIMARY KEY AUTO_INCREMENT,
					name TEXT,
					description TEXT
					);");
			$this->phylobyteDB->exec("
				CREATE TABLE IF NOT EXISTS p_users(
					id INTEGER PRIMARY KEY AUTO_INCREMENT,
					username TEXT,
					email TEXT,
					status TEXT,
					primarygroup TEXT,
					passwordhash TEXT,
					fname TEXT,
					lname TEXT,
					personalphone TEXT,
					publicphone TEXT,
					description TEXT
					);");
			$getRows = $this->phylobyteDB->prepare("SELECT COUNT(*) FROM p_groups");
			$getRows->execute();
			$numRows = $getRows->fetchAll();
			if($numRows[0][0] == 0){
			if($this->phylobyteDB->exec("
				INSERT INTO p_groups (name, description)
				VALUES ('admin', 'Phylobyte default administrator group');") &&
				$this->phylobyteDB->exec("INSERT INTO p_users (username, status, primarygroup, fname)
				VALUES ('admin', 'override', '1', 'Administrator');")){
					$this->messageAddDebug('Initialized Phylobyte User Tables');
				}
			}
		}catch(PDOException $e){}
		if($this->login()){
			$this->navBuild();
			$this->pageBuild();
		}
	}

	function messageStamp(){
		$this->messageStampItr++;
		return $this->messageStampBase.':'.$this->messageStampItr;
	}

	function login(){
		//do logout
		if($_REQUEST['phylobyte'] == 'logout'){
			unset($_SESSION['loginid']);
			$this->messageAddNotification('You are now logged out');
		}
		//do login
		if(isset($_SESSION['loginid'])){
			$userquery = $this->phylobyteDB->prepare("SELECT * FROM p_users WHERE id='{$_SESSION['loginid']}';");
			$userquery->execute();
			$queryResults = $userquery->fetchAll();
			$this->sessionUserInfo = $queryResults[0];
		}
		if(!isset($_SESSION['loginid']) || $this->sessionUserInfo['status'] == 'override'){
			include('loginform.php');
			if($accountverify == 'success') return true;
		}else{
			//credentials OK for now
			//query database and get user info. store to $sessionUserInfo
			$userquery = $this->phylobyteDB->prepare("SELECT * FROM p_users WHERE id='{$_SESSION['loginid']}';");
			$userquery->execute();
			$queryResults = $userquery->fetchAll();
			$this->sessionUserInfo = $queryResults[0];
			return true;
		}
	}
	
	function navBuild(){
		$this->navigationArea.='
		<ul>
		<li><a href="?">Home</a></li>';

		//ok, we are ready to build some navigation
		$pluginDirArray = scandir('../plugins');

		foreach($pluginDirArray as $possiblePlugin) {
			if(is_dir('../plugins/'.$possiblePlugin) && substr($possiblePlugin, -3) == '.on'){
				//now we make sure the plugin has the minimal requirements
				$pluginDir = $possiblePlugin;
				$pluginName = trim(preg_replace('#^\d+#', '', substr($possiblePlugin, 0, -3)));
				if(is_file('../plugins/'.$pluginDir.'/'.strtolower($pluginName).'.php') && is_file('../plugins/'.$pluginDir.'/'.$pluginName.'.php')){
					//we have the minimal plugin setup, so we can now generate navigation
					$this->navigationArea.='<li><a href="?plugin='.substr($pluginDir, 0, -3).'">'.$pluginName;
						//if there is just one other page, we must make subnav.
						$currentPluginDirArray = scandir('../plugins/'.$pluginDir);
						$functionsArray = null;
						foreach($currentPluginDirArray as $possibleFunction) {
							if(substr($possibleFunction, -4) == '.php' && $possibleFunction != $pluginName.'.php' && $possibleFunction != strtolower($pluginName).'.php'){
								$functionsArray[] = substr($possibleFunction, 0, -4);
							}
						}
						if(sizeof($functionsArray) > 0){
							$this->navigationArea.='&hellip;</a>';
							$this->navigationArea.='<ul>';
							foreach($functionsArray as $function) {
							    $this->navigationArea.='<li><a href="?plugin='.substr($pluginDir, 0, -3).'&amp;function='.$function.'">'.trim(preg_replace('#^\d+#', '', $function)).'</a></li>';
							}
							$this->navigationArea.='</ul>';
						}else{
							$this->navigationArea.='</a>';
						}
						
					//finish the list element
					$this->navigationArea.='</li>';
				}
			}
		}
		
		$this->navigationArea.='
		</ul>
		<ul style="float: right;">
			<li>
				<a href="../">View Website</a>
			</li>
			<li><a style="min-width: 10em; text-align: center;">Welcome, '.$this->sessionUserInfo['fname'].' '.$this->sessionUserInfo['lname'].'</a>
				<ul style="float: right; min-width: 100%;">
					<li><a href="?phylobyte=account">My Account</a></li>
					<li><a href="?phylobyte=settings">Settings</a></li>
					<li><a href="?phylobyte=logout">Log Out</a></li>
				</ul>
			</li>
		</ul>
		';
		return true;
	}
	
	function pageBuild(){
		//build the page based on the link, if nothing else, include home.
		if(!isset($_GET['plugin']) && !isset($_GET['phylobyte'])){
			include('home.php');
		}elseif($_GET['phylobyte'] == 'account'){
			include('account.php');
			return true;
		}elseif($_GET['phylobyte'] == 'settings'){
			//check "admin" first
			include('settings.php');
			return true;
		}else{
			//we have selected a plugin. Lets pull the name
			$pluginDir = stripslashes($_GET['plugin']).'.on';
			$pluginName = trim(preg_replace('#^\d+#', '', stripslashes($_GET['plugin'])));
			//include the class
			include_once('../plugins/'.$pluginDir.'/'.strtolower($pluginName).'.php');
			//possibly include the css
			if(is_file('../plugins/'.$pluginDir.'/'.strtolower($pluginName).'.css')){
				$this->headArea.='
		<link href="../plugins/'.$pluginDir.'/'.strtolower($pluginName).'.css" rel="stylesheet" type="text/css" />
				';
			}
			
			//modify the title
			$this->pageTitle.=' | '.$pluginName;

			//make some breadcrumbs
			$this->breadcrumbs.='<a href="?">Home</a> &raquo; <a href="?plugin='.substr($pluginDir, 0, -3).'">'.$pluginName.'</a>';

			
			
			//check the function
			if(!isset($_GET['function'])){
				//we include the default
				$includePlugin = '../plugins/'.$pluginDir.'/'.$pluginName.'.php';
				if(is_file('../plugins/'.$pluginDir.'/'.$pluginName.'.html')){
					$this->docArea.=stripslashes(file_get_contents('../plugins/'.$pluginDir.'/'.$pluginName.'.html'));
				}
			}else{
				//we include the function
				$function = stripslashes($_GET['function']);
				$this->pageTitle.=' &raquo; '.trim(preg_replace('#^\d+#', '', $function));
				$this->breadcrumbs.=' &raquo; <a href="?plugin='.substr($pluginDir, 0, -3).'&amp;function='.$function.'">'.trim(preg_replace('#^\d+#', '', $function)).'</a>';
				$includePlugin = '../plugins/'.$pluginDir.'/'.$function.'.php';
				if(is_file('../plugins/'.$pluginDir.'/'.$function.'.html')){
					$this->docArea=null;
					$this->docArea.=stripslashes(file_get_contents('../plugins/'.$pluginDir.'/'.$function.'.html'));
				}
			}
			
			include_once($includePlugin);
		}
		
		
		return true;
	}
	
	function build_finish(){
		$this->messageArea = $GLOBALS['MESSAGES']->pullquery('%v%', "SELECT * FROM __REGISTRY____pmessages WHERE mykey LIKE '{$this->messageStampBase}%';");
		$this->messageArea = str_replace('#e.', '<div class="error">', $this->messageArea);
		$this->messageArea = str_replace('#a.', '<div class="alert">', $this->messageArea);
		$this->messageArea = str_replace('#n.', '<div class="notification">', $this->messageArea);
		$this->messageArea = str_replace('#d.', '<div class="debug">', $this->messageArea);
		
		$this->messageArea = str_replace('##.', '</div>', $this->messageArea);
	}
	
	function messageAddAlert($alert){
		$GLOBALS['MESSAGES']->push($this->messageStamp(), '#a.'.$alert.'##.');
	}
	function messageAddError($error){
		$GLOBALS['MESSAGES']->push($this->messageStamp(), '#e.'.$error.'##.');
	}
	function messageAddNotification($notice){
		$GLOBALS['MESSAGES']->push($this->messageStamp(), '#n.'.$notice.'##.');
	}
	function messageAddDebug($debug){
		$GLOBALS['MESSAGES']->push($this->messageStamp(), '#d.'.$debug.'##.');
	}
}

?>