<?php
$this->pageTitle.=' | Log In';
//process
if(isset($_POST['p_submit']) || $this->sessionUserInfo['status'] == 'override'){
	
	if(isset($_POST['p_submit'])){
	
		if(strlen($currentUserName) == 0){
			$this->messageAddError('User Name can not be blank.');
		}
		if(strlen($currentPassword) == 0){
			$this->messageAddError('Password can not be blank.');
		}
	
		$currentUserName = sqlite_escape_string(trim(stripslashes($_POST['p_username'])));
		$currentPassword = sqlite_escape_string(trim(stripslashes($_POST['p_password'])));
		$userquery = $this->phylobyteDB->query("SELECT * FROM p_users WHERE username='$currentUserName';");
	}else{
		$userquery = $this->phylobyteDB->query("SELECT * FROM p_users WHERE id='{$_SESSION['loginid']}';");
	}
	
	$userqueryArray = $userquery->fetchArray();
	
	if($userqueryArray['id'] != null){
		//we have a user! we now check if override is set
		if($userqueryArray['status'] == 'override'){
			//log the user in anyway, and return true
			$_SESSION['loginid'] = $userqueryArray['id'];
			$this->pDB('clean');
			$this->messageAddAlert('You are now logged in with override.');
			include('accountSetup.php');
			return false;
		}
		//now check that user account is "active"
		//now check the password hash
	}
}else{
//build

$this->messageAddAlert('To use Phylobyte, you must log in.');

$this->docArea = '
<h3>Welcome to Phylobyte</h3>
<p>
Log in to Phylobyte using the form to the left. If you do not know your log in information, please contact your website administrator.
</p>
<h3>The Message Pile</h3>
<p>
The "Messages" slider, called the "Message Pile" contains often useful feedback based on your current actions. The drawer will show whenever there are messages, and will automatically roll up after three seconds. To open and close the drawer to either read messages or make extra space to work, click the tab.
</p>';

$this->pageArea = '
<img src="gfx/logo_color_md.png" />
<div style="float: right; width: 80%;">
	<h2>Love your website. Watch it grow.</h2>
</div>

<div class="floatfix">&nbsp;</div>

<fieldset style="float: right; width: 40%; margin-right: 15%;">
	<legend>Log In</legend>
<form action="?" method="POST">
	<label for="p_username">User Name</label><input type="text" name="p_username" value="'.$currentUserName.'"/><br/>
	<label for="p_password">Password</label><input type="password" name="p_password" value="'.$currentPassword.'"/><br/>
	<label for="p_submit">&nbsp;</label><input type="submit" name="p_submit" value="Submit Form" />
</form>
</fieldset>
';
}
?>
